<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rota Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
  :root {
    --jordan: #b8d9f0;
    --jordan-dark: #7ab3d6;
    --iryna: #f5c6d4;
    --iryna-dark: #e899b0;
    --holiday: #fef08a;
    --holiday-dark: #eab308;
    --error-border: #ef4444;
    --bg: #f8f7f5;
    --surface: #ffffff;
    --border: #e5e2dc;
    --text: #1a1815;
    --muted: #8a8580;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
  }

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
font-family: ‘DM Sans’, sans-serif;
background: var(–bg);
color: var(–text);
min-height: 100vh;
padding: 24px;
}

header {
display: flex;
align-items: flex-start;
justify-content: space-between;
margin-bottom: 28px;
flex-wrap: wrap;
gap: 16px;
}

.header-left h1 {
font-family: ‘Playfair Display’, serif;
font-size: 1.75rem;
color: var(–text);
letter-spacing: -0.02em;
margin-bottom: 6px;
}

.saved-rotas {
font-size: 0.78rem;
color: var(–muted);
display: flex;
flex-wrap: wrap;
align-items: center;
gap: 4px;
}

.saved-rotas .label { margin-right: 2px; }

.rota-tag {
display: inline-block;
background: var(–border);
border-radius: 5px;
padding: 2px 8px;
cursor: pointer;
transition: background 0.15s;
font-weight: 500;
font-size: 0.75rem;
}
.rota-tag:hover { background: #d0cec9; }
.rota-tag.active { background: var(–text); color: white; }

.header-right {
display: flex;
flex-direction: column;
gap: 10px;
align-items: flex-end;
}

.controls {
display: flex;
align-items: center;
gap: 12px;
flex-wrap: wrap;
justify-content: flex-end;
}

.controls label {
font-size: 0.8rem;
font-weight: 500;
color: var(–muted);
text-transform: uppercase;
letter-spacing: 0.08em;
}

input[type=“date”] {
font-family: ‘DM Sans’, sans-serif;
font-size: 0.9rem;
padding: 8px 14px;
border: 1.5px solid var(–border);
border-radius: 10px;
background: var(–surface);
color: var(–text);
outline: none;
cursor: pointer;
transition: border-color 0.2s;
}
input[type=“date”]:focus { border-color: #a0aec0; }

.legend {
display: flex;
gap: 14px;
align-items: center;
flex-wrap: wrap;
justify-content: flex-end;
}

.legend-item {
display: flex;
align-items: center;
gap: 6px;
font-size: 0.78rem;
font-weight: 500;
color: var(–muted);
}

.legend-dot { width: 11px; height: 11px; border-radius: 3px; }

.btn-export {
padding: 8px 16px;
background: var(–text);
color: white;
border: none;
border-radius: 10px;
font-family: ‘DM Sans’, sans-serif;
font-size: 0.85rem;
font-weight: 500;
cursor: pointer;
transition: background 0.15s;
}
.btn-export:hover { background: #333; }

/* Calendar */
.calendar-wrapper {
background: var(–surface);
border-radius: 18px;
box-shadow: var(–shadow);
overflow: hidden;
border: 1px solid var(–border);
}

.month-header {
padding: 14px 20px;
border-bottom: 1px solid var(–border);
display: flex;
align-items: center;
justify-content: space-between;
gap: 12px;
flex-wrap: wrap;
}

.month-title {
font-family: ‘Playfair Display’, serif;
font-size: 1.2rem;
color: var(–text);
}

.month-nav { display: flex; gap: 6px; }

.nav-btn {
width: 30px; height: 30px;
border: 1.5px solid var(–border);
background: var(–surface);
border-radius: 8px;
cursor: pointer;
font-size: 1rem;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.15s;
color: var(–text);
}
.nav-btn:hover { background: var(–bg); border-color: #bbb; }

.weekday-headers {
display: grid;
grid-template-columns: repeat(7, 1fr);
background: #faf9f7;
border-bottom: 1px solid var(–border);
}

.weekday-header {
padding: 9px 4px;
text-align: center;
font-size: 0.7rem;
font-weight: 600;
color: var(–muted);
text-transform: uppercase;
letter-spacing: 0.06em;
}

.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
}

.day-cell {
border-right: 1px solid var(–border);
border-bottom: 1px solid var(–border);
min-height: 90px;
padding: 7px;
cursor: pointer;
transition: filter 0.15s;
}

.day-cell:nth-child(7n) { border-right: none; }
.day-cell:hover:not(.other-month) { filter: brightness(0.96); }

.day-cell.other-month {
background: #faf9f7;
cursor: default;
}

.day-cell.today .day-number {
background: var(–text);
color: white !important;
border-radius: 50%;
}

.day-cell.jordan-day  { background: var(–jordan); }
.day-cell.iryna-day   { background: var(–iryna); }
.day-cell.holiday-day { background: var(–holiday); }
.day-cell.both-day    { background: linear-gradient(135deg, var(–jordan) 50%, var(–iryna) 50%); }

.day-cell.week-error:not(.holiday-day) {
box-shadow: inset 0 0 0 2px var(–error-border);
}

.day-number {
font-size: 0.8rem;
font-weight: 600;
color: var(–text);
margin-bottom: 4px;
width: 22px; height: 22px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 50%;
}

.other-month .day-number { color: #ccc; }

.shift-chips { display: flex; flex-direction: column; gap: 2px; }

.shift-chip {
font-size: 0.63rem;
font-weight: 500;
padding: 2px 5px;
border-radius: 4px;
line-height: 1.4;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.chip-jordan  { background: rgba(255,255,255,0.55); color: #2d6a9f; border: 1px solid var(–jordan-dark); }
.chip-iryna   { background: rgba(255,255,255,0.55); color: #9f2d5a; border: 1px solid var(–iryna-dark); }
.chip-holiday { background: rgba(255,255,255,0.55); color: #7a6000; border: 1px solid var(–holiday-dark); }

.week-hours-row {
grid-column: span 7;
display: flex;
gap: 8px;
padding: 5px 12px;
background: #faf9f7;
border-bottom: 1px solid var(–border);
font-size: 0.72rem;
color: var(–muted);
flex-wrap: wrap;
align-items: center;
}

.hours-badge {
padding: 1px 8px;
border-radius: 20px;
font-weight: 500;
font-size: 0.7rem;
}

.hours-badge.jordan { background: var(–jordan); color: #2d6a9f; }
.hours-badge.iryna  { background: var(–iryna);  color: #9f2d5a; }
.hours-badge.err    { background: var(–error-border); color: white; }

/* Modal */
.modal-overlay {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.35);
backdrop-filter: blur(4px);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
opacity: 0;
pointer-events: none;
transition: opacity 0.2s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }

.modal {
background: var(–surface);
border-radius: 18px;
padding: 26px;
width: 100%;
max-width: 430px;
box-shadow: 0 20px 60px rgba(0,0,0,0.2);
transform: translateY(10px);
transition: transform 0.2s;
max-height: 90vh;
overflow-y: auto;
}
.modal-overlay.open .modal { transform: translateY(0); }

.modal-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 18px;
}

.modal-title { font-family: ‘Playfair Display’, serif; font-size: 1.1rem; }

.modal-close {
width: 28px; height: 28px;
border: none; background: #f0eeeb;
border-radius: 50%; cursor: pointer;
font-size: 0.9rem;
display: flex; align-items: center; justify-content: center;
color: var(–muted); transition: background 0.15s;
}
.modal-close:hover { background: var(–border); }

.form-section { margin-bottom: 18px; }

.form-section-title {
font-size: 0.72rem;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.08em;
color: var(–muted);
margin-bottom: 8px;
padding-bottom: 5px;
border-bottom: 1px solid var(–border);
}

.person-toggle { display: flex; gap: 7px; }

.person-btn {
flex: 1; padding: 7px;
border: 2px solid transparent;
border-radius: 10px; cursor: pointer;
font-family: ‘DM Sans’, sans-serif;
font-size: 0.83rem; font-weight: 500;
transition: all 0.15s;
background: var(–bg); color: var(–muted);
}

.person-btn.jordan.active  { background: var(–jordan); border-color: var(–jordan-dark); color: #2d6a9f; }
.person-btn.iryna.active   { background: var(–iryna);  border-color: var(–iryna-dark);  color: #9f2d5a; }
.person-btn.holiday.active { background: var(–holiday); border-color: var(–holiday-dark); color: #7a6000; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-bottom: 9px; }

.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label { font-size: 0.72rem; font-weight: 500; color: var(–muted); }

.form-group input, .form-group select {
font-family: ‘DM Sans’, sans-serif;
font-size: 0.85rem;
padding: 7px 11px;
border: 1.5px solid var(–border);
border-radius: 8px;
background: var(–bg);
color: var(–text);
outline: none;
transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus { border-color: #a0aec0; }

.hours-display {
font-size: 0.8rem; font-weight: 600;
color: var(–text); background: var(–bg);
padding: 5px 11px; border-radius: 7px;
margin-top: 3px; display: inline-block;
}

.shift-editor { display: none; }
.shift-editor.visible { display: block; }

.modal-footer {
display: flex; gap: 9px;
justify-content: flex-end; margin-top: 18px;
}

.btn {
padding: 8px 16px; border-radius: 9px; border: none;
font-family: ‘DM Sans’, sans-serif;
font-size: 0.85rem; font-weight: 500;
cursor: pointer; transition: all 0.15s;
}
.btn-primary   { background: var(–text); color: white; }
.btn-primary:hover { background: #333; }
.btn-secondary { background: var(–bg); color: var(–muted); border: 1.5px solid var(–border); }
.btn-secondary:hover { background: var(–border); }
.btn-danger    { background: #fee2e2; color: var(–error-border); border: 1.5px solid #fca5a5; margin-right: auto; }
.btn-danger:hover { background: #fca5a5; }

/* ── PRINT STYLES ── */
.print-title { display: none; }

@media print {
@page { size: A4 landscape; margin: 8mm 10mm; }

```
body {
  padding: 0;
  background: white;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

header, .modal-overlay { display: none !important; }

.print-title {
  display: block !important;
  font-family: 'Playfair Display', serif;
  font-size: 14pt;
  font-weight: 600;
  text-align: center;
  margin-bottom: 6px;
  color: #1a1815;
}

.calendar-wrapper {
  border-radius: 0;
  box-shadow: none;
  border: 1px solid #ccc;
  width: 100%;
}

.month-header { padding: 5px 12px; }
.month-title  { font-size: 10pt; }
.month-nav    { display: none !important; }

.weekday-header { padding: 5px 2px; font-size: 7pt; }

.day-cell    { min-height: 0; padding: 3px 5px; cursor: default; }
.day-number  { font-size: 7pt; width: 16px; height: 16px; }
.shift-chip  { font-size: 6pt; padding: 1px 3px; }

.week-hours-row { padding: 3px 8px; font-size: 6.5pt; gap: 6px; }
.hours-badge    { font-size: 6pt; padding: 1px 5px; }
```

}
</style>

</head>
<body>

<div class="print-title" id="printTitle"></div>

<header>
  <div class="header-left">
    <h1>Rota Manager</h1>
    <div class="saved-rotas" id="savedRotasList"></div>
  </div>
  <div class="header-right">
    <div class="controls">
      <label>Week commencing</label>
      <input type="date" id="weekStart" />
      <button class="btn-export" onclick="window.print()">⬇ Export PDF</button>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--jordan)"></div>Jordan</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--iryna)"></div>Iryna</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--holiday)"></div>Holiday</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--error-border);border-radius:50%"></div>Hours error</div>
    </div>
  </div>
</header>

<div class="calendar-wrapper">
  <div class="month-header">
    <div class="month-nav">
      <button class="nav-btn" onclick="shiftMonth(-1)">&#8249;</button>
      <button class="nav-btn" onclick="shiftMonth(1)">&#8250;</button>
    </div>
    <span class="month-title" id="monthTitle"></span>
  </div>
  <div class="weekday-headers">
    <div class="weekday-header">Monday</div>
    <div class="weekday-header">Tuesday</div>
    <div class="weekday-header">Wednesday</div>
    <div class="weekday-header">Thursday</div>
    <div class="weekday-header">Friday</div>
    <div class="weekday-header">Saturday</div>
    <div class="weekday-header">Sunday</div>
  </div>
  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<!-- Modal -->

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Edit Day</div>
      <button class="modal-close" onclick="closeModal()">&#10005;</button>
    </div>

```
<div class="form-section">
  <div class="form-section-title">Person</div>
  <div class="person-toggle">
    <button class="person-btn jordan"  onclick="togglePerson('jordan')">Jordan</button>
    <button class="person-btn iryna"   onclick="togglePerson('iryna')">Iryna</button>
    <button class="person-btn holiday" onclick="togglePerson('holiday')">Holiday</button>
  </div>
</div>

<div class="shift-editor" id="jordanShift">
  <div class="form-section">
    <div class="form-section-title">Jordan's Shift</div>
    <div class="form-row">
      <div class="form-group"><label>Start</label><input type="time" id="j-start" oninput="recalcHours('jordan')"></div>
      <div class="form-group"><label>End</label><input type="time" id="j-end" oninput="recalcHours('jordan')"></div>
    </div>
    <div class="form-group"><label>Break (minutes)</label><input type="number" id="j-break" value="30" min="0" max="120" oninput="recalcHours('jordan')"></div>
    <div class="hours-display" id="j-hours-display">&#8211; hrs</div>
  </div>
</div>

<div class="shift-editor" id="irynaShift">
  <div class="form-section">
    <div class="form-section-title">Iryna's Shift</div>
    <div class="form-row">
      <div class="form-group"><label>Start</label><input type="time" id="i-start" oninput="recalcHours('iryna')"></div>
      <div class="form-group"><label>End</label><input type="time" id="i-end" oninput="recalcHours('iryna')"></div>
    </div>
    <div class="form-group"><label>Break (minutes)</label><input type="number" id="i-break" value="30" min="0" max="120" oninput="recalcHours('iryna')"></div>
    <div class="hours-display" id="i-hours-display">&#8211; hrs</div>
  </div>
</div>

<div class="shift-editor" id="holidayShift">
  <div class="form-section">
    <div class="form-section-title">Holiday</div>
    <div class="form-group">
      <label>Who is on holiday?</label>
      <select id="holiday-person">
        <option value="both">Both</option>
        <option value="jordan">Jordan</option>
        <option value="iryna">Iryna</option>
      </select>
    </div>
    <div class="form-group" style="margin-top:8px">
      <label>Note (optional)</label>
      <input type="text" id="holiday-note" placeholder="e.g. Annual Leave">
    </div>
  </div>
</div>

<div class="modal-footer">
  <button class="btn btn-danger"    id="clearBtn" onclick="clearDay()" style="display:none">Clear Day</button>
  <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  <button class="btn btn-primary"   onclick="saveDay()">Save</button>
</div>
```

  </div>
</div>

<script>
// ── Storage ───────────────────────────────────────────────────
const PREFIX = 'rota_';

function storageKey(year, month) {
  return PREFIX + year + '_' + String(month + 1).padStart(2, '0');
}

function rotaLabel(year, month) {
  return 'Rota ' + new Date(year, month, 1).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
}

function loadMonth(year, month) {
  try { return JSON.parse(localStorage.getItem(storageKey(year, month)) || '{}'); }
  catch(e) { return {}; }
}

function saveMonth(year, month, data) {
  localStorage.setItem(storageKey(year, month), JSON.stringify(data));
}

function getAllSaved() {
  const out = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith(PREFIX)) {
      const parts = k.slice(PREFIX.length).split('_');
      if (parts.length === 2) {
        const y = parseInt(parts[0]), m = parseInt(parts[1]) - 1;
        if (!isNaN(y) && !isNaN(m)) out.push({ year: y, month: m });
      }
    }
  }
  out.sort((a, b) => a.year !== b.year ? a.year - b.year : a.month - b.month);
  return out;
}

// ── State ─────────────────────────────────────────────────────
let currentMonth;
let rotaData = {};
let editingKey = null;
let activePersons = new Set();

// Init
const today = new Date();
const dow = today.getDay();
const monday = new Date(today);
monday.setDate(today.getDate() - (dow === 0 ? 6 : dow - 1));
document.getElementById('weekStart').value = monday.toISOString().split('T')[0];

currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
loadAndRender();

document.getElementById('weekStart').addEventListener('change', function() {
  const d = new Date(this.value);
  if (!isNaN(d)) {
    currentMonth = new Date(d.getFullYear(), d.getMonth(), 1);
    loadAndRender();
  }
});

function shiftMonth(dir) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + dir, 1);
  loadAndRender();
}

function loadAndRender() {
  rotaData = loadMonth(currentMonth.getFullYear(), currentMonth.getMonth());
  renderCalendar();
  renderSavedList();
}

// ── Helpers ───────────────────────────────────────────────────
function dk(d) { return d.toISOString().split('T')[0]; }

function calcH(start, end, brk) {
  if (!start || !end) return 0;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  let m = (eh * 60 + em) - (sh * 60 + sm) - (Number(brk) || 0);
  if (m < 0) m += 1440;
  return Math.max(0, m / 60);
}

function weekDates(wStart, blanks, year, month, dim) {
  const out = [];
  for (let j = 0; j < 7; j++) {
    const dn = wStart - blanks + 1 + j;
    if (dn >= 1 && dn <= dim) out.push(new Date(year, month, dn));
  }
  return out;
}

function weekHours(dates) {
  let j = 0, i = 0;
  dates.forEach(d => {
    const data = rotaData[dk(d)];
    if (data && data.type !== 'holiday') {
      if (data.jordan && data.jordan.start) j += calcH(data.jordan.start, data.jordan.end, data.jordan.breakMins);
      if (data.iryna  && data.iryna.start)  i += calcH(data.iryna.start,  data.iryna.end,  data.iryna.breakMins);
    }
  });
  return { j, i };
}

// ── Render ────────────────────────────────────────────────────
function renderCalendar() {
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';

  const label = currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  document.getElementById('monthTitle').textContent = label;
  document.getElementById('printTitle').textContent = rotaLabel(year, month);

  const firstDow = new Date(year, month, 1).getDay();
  const blanks = firstDow === 0 ? 6 : firstDow - 1;
  const dim = new Date(year, month + 1, 0).getDate();
  const total = Math.ceil((blanks + dim) / 7) * 7;
  const todayKey = dk(new Date());
  const weeks = total / 7;

  // Pre-compute week stats
  const wstats = [];
  for (let w = 0; w < weeks; w++) {
    const dates = weekDates(w * 7, blanks, year, month, dim);
    const { j, i } = weekHours(dates);
    const err = (j > 0 && j < 40) || (i > 0 && i < 12);
    wstats.push({ j, i, err, dates });
  }

  for (let idx = 0; idx < total; idx++) {
    const w = Math.floor(idx / 7);
    const dn = idx - blanks + 1;
    const inMonth = dn >= 1 && dn <= dim;
    const cellDate = new Date(year, month, dn);
    const key = dk(cellDate);

    const cell = document.createElement('div');
    cell.className = 'day-cell';

    if (!inMonth) {
      cell.classList.add('other-month');
    } else {
      if (key === todayKey) cell.classList.add('today');

      const data = rotaData[key];
      if (data) {
        if (data.type === 'holiday') {
          cell.classList.add('holiday-day');
        } else {
          const hj = data.jordan && data.jordan.start;
          const hi = data.iryna  && data.iryna.start;
          if (hj && hi) cell.classList.add('both-day');
          else if (hj)  cell.classList.add('jordan-day');
          else if (hi)  cell.classList.add('iryna-day');
        }
      }

      if (wstats[w].err) cell.classList.add('week-error');
      cell.addEventListener('click', function() { openModal(key, cellDate); });

      const numDiv = document.createElement('div');
      numDiv.className = 'day-number';
      numDiv.textContent = dn;
      cell.appendChild(numDiv);

      if (data) {
        const chips = document.createElement('div');
        chips.className = 'shift-chips';

        if (data.type === 'holiday') {
          const ch = document.createElement('div');
          ch.className = 'shift-chip chip-holiday';
          const who = data.holiday && data.holiday.person ? data.holiday.person : 'both';
          ch.textContent = '\uD83C\uDF34 ' + (who === 'both' ? 'Both' : who.charAt(0).toUpperCase() + who.slice(1));
          chips.appendChild(ch);
        } else {
          if (data.jordan && data.jordan.start) {
            const h = calcH(data.jordan.start, data.jordan.end, data.jordan.breakMins).toFixed(1);
            const ch = document.createElement('div');
            ch.className = 'shift-chip chip-jordan';
            ch.textContent = 'J: ' + data.jordan.start + '\u2013' + data.jordan.end + ' (' + h + 'h)';
            chips.appendChild(ch);
          }
          if (data.iryna && data.iryna.start) {
            const h = calcH(data.iryna.start, data.iryna.end, data.iryna.breakMins).toFixed(1);
            const ch = document.createElement('div');
            ch.className = 'shift-chip chip-iryna';
            ch.textContent = 'I: ' + data.iryna.start + '\u2013' + data.iryna.end + ' (' + h + 'h)';
            chips.appendChild(ch);
          }
        }
        cell.appendChild(chips);
      }
    }

    if (!inMonth) {
      const numDiv = document.createElement('div');
      numDiv.className = 'day-number';
      cell.appendChild(numDiv);
    }

    grid.appendChild(cell);

    // After each full week row, add summary
    if ((idx + 1) % 7 === 0) {
      const stat = wstats[w];
      if (stat.dates.length > 0) {
        const row = document.createElement('div');
        row.className = 'week-hours-row';

        const lbl = document.createElement('span');
        lbl.textContent = 'w/c ' + stat.dates[0].toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ':';
        row.appendChild(lbl);

        const jErr = stat.j > 0 && stat.j < 40;
        const iErr = stat.i > 0 && stat.i < 12;

        const jb = document.createElement('span');
        jb.className = 'hours-badge jordan' + (jErr ? ' err' : '');
        jb.textContent = 'Jordan: ' + stat.j.toFixed(1) + 'h' + (jErr ? ' \u26A0 <40h' : '');
        row.appendChild(jb);

        const ib = document.createElement('span');
        ib.className = 'hours-badge iryna' + (iErr ? ' err' : '');
        ib.textContent = 'Iryna: ' + stat.i.toFixed(1) + 'h' + (iErr ? ' \u26A0 <12h' : '');
        row.appendChild(ib);

        grid.appendChild(row);
      }
    }
  }
}

function renderSavedList() {
  const all = getAllSaved();
  const el = document.getElementById('savedRotasList');
  el.innerHTML = '';
  if (all.length === 0) return;

  const lbl = document.createElement('span');
  lbl.className = 'label';
  lbl.textContent = 'Saved:';
  el.appendChild(lbl);

  all.forEach(function(r) {
    const tag = document.createElement('span');
    tag.className = 'rota-tag';
    tag.textContent = rotaLabel(r.year, r.month);
    if (r.year === currentMonth.getFullYear() && r.month === currentMonth.getMonth()) {
      tag.classList.add('active');
    }
    tag.addEventListener('click', function() {
      currentMonth = new Date(r.year, r.month, 1);
      loadAndRender();
    });
    el.appendChild(tag);
  });
}

// ── Modal ─────────────────────────────────────────────────────
function openModal(key, cellDate) {
  editingKey = key;
  activePersons = new Set();

  document.getElementById('modalTitle').textContent =
    cellDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });

  ['jordan','iryna','holiday'].forEach(function(p) {
    document.querySelector('.person-btn.' + p).classList.remove('active');
  });
  document.getElementById('jordanShift').classList.remove('visible');
  document.getElementById('irynaShift').classList.remove('visible');
  document.getElementById('holidayShift').classList.remove('visible');

  ['j-start','j-end','i-start','i-end'].forEach(function(id) {
    document.getElementById(id).value = '';
  });
  document.getElementById('j-break').value = 30;
  document.getElementById('i-break').value = 30;
  document.getElementById('j-hours-display').textContent = '\u2013 hrs';
  document.getElementById('i-hours-display').textContent = '\u2013 hrs';
  document.getElementById('holiday-person').value = 'both';
  document.getElementById('holiday-note').value = '';

  const data = rotaData[key];
  document.getElementById('clearBtn').style.display = data ? 'inline-block' : 'none';

  if (data) {
    if (data.type === 'holiday') {
      activatePerson('holiday', false);
      document.getElementById('holiday-person').value = (data.holiday && data.holiday.person) ? data.holiday.person : 'both';
      document.getElementById('holiday-note').value   = (data.holiday && data.holiday.note)   ? data.holiday.note   : '';
    } else {
      if (data.jordan) {
        activatePerson('jordan', false);
        document.getElementById('j-start').value = data.jordan.start || '';
        document.getElementById('j-end').value   = data.jordan.end   || '';
        document.getElementById('j-break').value = data.jordan.breakMins !== undefined ? data.jordan.breakMins : 30;
        recalcHours('jordan');
      }
      if (data.iryna) {
        activatePerson('iryna', false);
        document.getElementById('i-start').value = data.iryna.start || '';
        document.getElementById('i-end').value   = data.iryna.end   || '';
        document.getElementById('i-break').value = data.iryna.breakMins !== undefined ? data.iryna.breakMins : 30;
        recalcHours('iryna');
      }
    }
  }

  document.getElementById('modalOverlay').classList.add('open');
}

function activatePerson(person, toggle) {
  if (toggle === undefined) toggle = true;

  if (person === 'holiday') {
    activePersons = new Set(['holiday']);
    document.querySelector('.person-btn.jordan').classList.remove('active');
    document.querySelector('.person-btn.iryna').classList.remove('active');
    document.getElementById('jordanShift').classList.remove('visible');
    document.getElementById('irynaShift').classList.remove('visible');
    document.querySelector('.person-btn.holiday').classList.add('active');
    document.getElementById('holidayShift').classList.add('visible');
  } else {
    activePersons.delete('holiday');
    document.querySelector('.person-btn.holiday').classList.remove('active');
    document.getElementById('holidayShift').classList.remove('visible');

    var shiftId = person === 'jordan' ? 'jordanShift' : 'irynaShift';
    if (toggle && activePersons.has(person)) {
      activePersons.delete(person);
      document.querySelector('.person-btn.' + person).classList.remove('active');
      document.getElementById(shiftId).classList.remove('visible');
    } else {
      activePersons.add(person);
      document.querySelector('.person-btn.' + person).classList.add('active');
      document.getElementById(shiftId).classList.add('visible');
    }
  }
}

function togglePerson(p) { activatePerson(p, true); }

function recalcHours(person) {
  var start, end, brk, displayId;
  if (person === 'jordan') {
    start = document.getElementById('j-start').value;
    end   = document.getElementById('j-end').value;
    brk   = document.getElementById('j-break').value;
    displayId = 'j-hours-display';
  } else {
    start = document.getElementById('i-start').value;
    end   = document.getElementById('i-end').value;
    brk   = document.getElementById('i-break').value;
    displayId = 'i-hours-display';
  }
  var h = calcH(start, end, brk);
  document.getElementById(displayId).textContent = h > 0 ? h.toFixed(2) + ' hrs' : '\u2013 hrs';
}

function saveDay() {
  if (activePersons.size === 0) { closeModal(); return; }
  var year  = currentMonth.getFullYear();
  var month = currentMonth.getMonth();

  if (activePersons.has('holiday')) {
    rotaData[editingKey] = {
      type: 'holiday',
      holiday: {
        person: document.getElementById('holiday-person').value,
        note:   document.getElementById('holiday-note').value
      }
    };
  } else {
    var entry = { type: 'shift' };
    if (activePersons.has('jordan')) {
      entry.jordan = {
        start:     document.getElementById('j-start').value,
        end:       document.getElementById('j-end').value,
        breakMins: Number(document.getElementById('j-break').value)
      };
    }
    if (activePersons.has('iryna')) {
      entry.iryna = {
        start:     document.getElementById('i-start').value,
        end:       document.getElementById('i-end').value,
        breakMins: Number(document.getElementById('i-break').value)
      };
    }
    rotaData[editingKey] = entry;
  }

  saveMonth(year, month, rotaData);
  closeModal();
  renderCalendar();
  renderSavedList();
}

function clearDay() {
  delete rotaData[editingKey];
  saveMonth(currentMonth.getFullYear(), currentMonth.getMonth(), rotaData);
  closeModal();
  renderCalendar();
  renderSavedList();
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  editingKey = null;
  activePersons = new Set();
}

document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>

</body>
</html>
